{% extends "base.html" %}
{% block content %}
  <h2>Chat (globalny pokój)</h2>
  <div id="chat-box" class="chat-box"></div>
  <form id="chat-form" class="form row" onsubmit="return sendMsg(event)">
    <input type="text" id="chat-input" placeholder="Napisz wiadomość..." required>
    <button type="submit">Wyślij</button>
  </form>

  <script>
    let IS_ADMIN = {{ current_user.is_admin|tojson }};
    let lastTs = null;

    async function loadNew() {
      let url = "/api/chat/messages";
      if (lastTs) {
        url += "?after=" + encodeURIComponent(lastTs);
      }
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          const box = document.getElementById("chat-box");
          data.forEach(m => {
            const div = document.createElement("div");
            div.className = "msg";
            const when = new Date(m.created_at).toLocaleString();
            let msgHtml = `<span>[${when}] ${m.user}: ${m.content}</span>`;
            if (IS_ADMIN) {
              msgHtml += ` <button class="chat-delete-btn" onclick="deleteMsg(${m.id}, this)">Usuń</button>`;
            }
            div.innerHTML = msgHtml;
            box.appendChild(div);
          });
          box.scrollTop = box.scrollHeight;
          lastTs = data[data.length - 1].created_at;
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function sendMsg(e) {
      e.preventDefault();
      const input = document.getElementById("chat-input");
      const content = input.value.trim();
      if (!content) return false;
      input.value = "";
      try {
        await fetch("/api/chat/send", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({content})
        });
      } catch (e) {
        console.error(e);
      }
      return false;
    }
    

    async function deleteMsg(messageId, buttonElement) {
      if (!confirm("Na pewno usunąć tę wiadomość?")) return;
      
      try {
        const res = await fetch(`/api/chat/message/${messageId}/delete`, {
          method: "POST"
        });
        const data = await res.json();
        
        if (data.ok) {
          // Usuń całą wiadomość (element <div>) z widoku
          buttonElement.parentElement.remove();
        } else {
          alert("Błąd: " + (data.error || "Nieznany błąd"));
        }
      } catch (e) {
        console.error(e);
        alert("Błąd sieciowy podczas usuwania.");
      }
    }
   
    // Start polling
    loadNew();
    setInterval(loadNew, 2000);
  </script>
{% endblock %}
